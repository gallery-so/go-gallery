name: ci
on: [push]
jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - name: Dump GitHub context
        run: echo "$GITHUB_CONTEXT"
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
      - uses: actions/checkout@v2
      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.19
      - name: "Install Dependencies"
        run: |
          go mod download
          go install gotest.tools/gotestsum@v1.8.2
      - name: "Update apt"
        run: sudo apt-get update
      - name: "Download sops"
        run: curl --remote-name https://github.com/mozilla/sops/releases/download/v3.7.3/sops_3.7.3_amd64.deb
      - name: "Install sops"
        run: sudo apt-get install ./sops_3.7.3_amd64.deb
      - name: "ls"
        run: ls
      - id: "auth"
        uses: "google-github-actions/auth@v0"
        with:
          credentials_json: "${{ secrets.GCP_DEV_CREDENTIALS }}"
      - name: "Install gcloud cli"
        uses: google-github-actions/setup-gcloud@v0
      - name: Test
        run: |
          mkdir -p /tmp/test-reports
          gotestsum --junitfile /tmp/test-reports/integration-tests.xml -- -race -run TestIntegrationTest ./server/... -args -chain ethereum -chainID 1
      - name: "Run indexer tests"
        run: |
          mkdir -p /tmp/test-reports
          gotestsum --junitfile /tmp/test-reports/indexer-integration-tests.xml -- -race ./indexer/...
  unit:
    runs-on: ubuntu-latest
    steps:
      - name: Dump GitHub context
        run: echo "$GITHUB_CONTEXT"
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
      - uses: actions/checkout@v2
      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.19
      - name: "Install Dependencies"
        run: |
          go mod download
          go install gotest.tools/gotestsum@v1.8.2
      - name: "Update apt"
        run: sudo apt-get update
      - name: "Download sops"
        run: curl --remote-name https://github.com/mozilla/sops/releases/download/v3.7.3/sops_3.7.3_amd64.deb
      - name: "Install sops"
        run: sudo apt-get install ./sops_3.7.3_amd64.deb
      - name: "ls"
        run: ls
      - id: "auth"
        uses: "google-github-actions/auth@v0"
        with:
          credentials_json: "${{ secrets.GCP_DEV_CREDENTIALS }}"
      - name: "Install gcloud cli"
        uses: google-github-actions/setup-gcloud@v0
      - name: Test
        run: |
          mkdir -p /tmp/test-reports
          gotestsum --junitfile /tmp/test-reports/unit-tests.xml -- -short ./...

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18.x
      - name: Install Dependencies
        run: yarn install
      - name: Enforce GraphQL Format
        run: yarn prettier --check graphql/schema/schema.graphql
